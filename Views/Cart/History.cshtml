@model List<ASM_WebBanNuocUong.Models.DonHang>
@{
    ViewData["Title"] = "Lịch Sử Đơn Hàng";
}

<div class="container mt-5 pb-5">
    <div class="d-flex align-items-center mb-4">
        <div class="p-3 rounded-circle bg-primary text-white me-3 shadow-sm">
            <i class="fas fa-history fa-lg"></i>
        </div>
        <div>
            <h2 class="fw-bold m-0" style="color: var(--brown-dark);">Lịch Sử Mua Hàng</h2>
            <p class="text-muted m-0">Theo dõi trạng thái các món nước bạn đã đặt</p>
        </div>
    </div>

    @if (TempData["ThongBao"] != null)
    {
        <div class="alert alert-success border-0 shadow-sm rounded-4 mb-4">
            <i class="fas fa-check-circle me-2"></i> @TempData["ThongBao"]
        </div>
    }

    @if (Model == null || Model.Count == 0)
    {
        <div class="text-center py-5 bg-white rounded-4 shadow-sm">
            <img src="https://cdn-icons-png.flaticon.com/512/4076/4076432.png" style="width: 150px; opacity: 0.5;" class="mb-4">
            <h4 class="text-muted">Bạn chưa có đơn hàng nào</h4>
            <a href="/Home/Index" class="btn btn-primary rounded-pill px-4 mt-3" style="background-color: var(--brown-dark); border:none;">Mua sắm ngay thôi!</a>
        </div>
    }
    else
    {
        @foreach (var item in Model)
        {
            <div class="card mb-4 border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header border-0 d-flex justify-content-between align-items-center px-4 py-3" style="background-color: #f8f9fa;">
                    <div>
                        <span class="badge bg-dark rounded-pill me-2">#@item.MaDonHang.ToString().Substring(0, 8).ToUpper()</span>
                        <small class="text-muted"><i class="far fa-calendar-alt me-1"></i> @item.NgayDat.ToString("dd/MM/yyyy HH:mm")</small>
                    </div>
                    <div>
                        @{
                            var (badgeClass, icon) = item.TrangThai switch
                            {
                                "Chờ xác nhận" => ("bg-warning text-dark", "fa-clock"),
                                "Đang giao" => ("bg-info text-white", "fa-truck"),
                                "Đã giao" => ("bg-success text-white", "fa-check-double"),
                                "Đã hủy" => ("bg-danger text-white", "fa-times-circle"),
                                _ => ("bg-secondary text-white", "fa-info-circle")
                            };
                        }
                        <span class="badge @badgeClass px-3 py-2 rounded-pill shadow-sm">
                            <i class="fas @icon me-1"></i> @item.TrangThai
                        </span>
                    </div>
                </div>
                <div class="card-body px-4">
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle mb-0">
                            <thead class="text-muted small text-uppercase">
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th class="text-center">Số lượng</th>
                                    <th class="text-end">Đơn giá</th>
                                    <th class="text-end">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (item.DanhSachChiTiet != null)
                                {
                                    @foreach (var ct in item.DanhSachChiTiet)
                                    {
                                        <tr class="border-bottom-dashed">
                                            <td class="py-3">
                                                <span class="fw-bold" style="color: var(--brown-dark);">
                                                    @(ct.LoaiSanPham == "Combo" ? ct.Combo?.TenCombo : ct.SanPham?.TenSanPham)
                                                </span>
                                                @if(ct.LoaiSanPham == "Combo"){ <span class="badge bg-light text-dark border ms-1">Combo</span> }
                                            </td>
                                            <td class="text-center">x@ct.SoLuong</td>
                                            <td class="text-end text-muted">@ct.Gia.ToString("N0")đ</td>
                                            <td class="text-end fw-bold">@((ct.SoLuong * ct.Gia).ToString("N0"))đ</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-0 px-4 py-3 d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted me-2">Tổng thanh toán:</span>
                        <span class="fs-4 fw-bold text-danger">@item.TongTien.ToString("N0")đ</span>
                    </div>
                    <div class="btn-group">
                        @if (item.TrangThai == "Chờ xác nhận")
                        {
                            <button class="btn btn-outline-danger btn-sm rounded-pill px-3 me-2" onclick="cancelOrder('@item.MaDonHang')">
                                <i class="fas fa-ban me-1"></i> Hủy đơn
                            </button>
                        }
                        <a href="/Order/Details/@item.MaDonHang" class="btn btn-outline-dark btn-sm rounded-pill px-3">
                            Chi tiết <i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    .border-bottom-dashed { border-bottom: 1px dashed #dee2e6; }
    .card { transition: transform 0.2s; }
    .card:hover { transform: translateY(-3px); }
</style>