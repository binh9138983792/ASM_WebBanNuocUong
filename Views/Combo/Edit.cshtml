@model Combo
@{
    ViewData["Title"] = "Sửa Combo";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-0 shadow-lg rounded-4 border-top border-warning border-5">
                <div class="card-body p-5">
                    <h3 class="fw-bold mb-4 text-center"><i class="fas fa-edit me-2 text-warning"></i>Sửa Combo</h3>
                    
                    <form asp-action="Edit" id="comboForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger small mb-3"></div>
                        <input type="hidden" asp-for="MaCombo" />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="TenCombo" class="form-label fw-bold small">Tên Combo</label>
                                    <input asp-for="TenCombo" class="form-control rounded-3 shadow-sm" />
                                    <span asp-validation-for="TenCombo" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Gia" class="form-label fw-bold small">Giá (VNĐ)</label>
                                    <div class="input-group">
                                        <input asp-for="Gia" type="number" id="giaCombo" class="form-control rounded-3 shadow-sm" />
                                        <button type="button" class="btn btn-outline-secondary" onclick="tinhGiaTuDong()">
                                            <i class="fas fa-calculator"></i> Tự tính
                                        </button>
                                    </div>
                                    <small class="text-muted">Để trống và bấm "Tự tính" để tính giá tự động</small>
                                    <span asp-validation-for="Gia" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="MoTa" class="form-label fw-bold small">Mô tả</label>
                            <textarea asp-for="MoTa" class="form-control rounded-3 shadow-sm" rows="3"></textarea>
                        </div>

                        <!-- SẢN PHẨM TRONG COMBO -->
                        <div class="mb-4 border rounded-3 p-4 bg-light">
                            <h5 class="fw-bold mb-3"><i class="fas fa-list me-2 text-success"></i>Sản phẩm trong Combo</h5>
                            <div id="product-container">
                                @if (Model.DanhSachChiTietCombo != null && Model.DanhSachChiTietCombo.Any())
                                {
                                    int index = 0;
                                    foreach (var item in Model.DanhSachChiTietCombo)
                                    {
                                        <div class="row mb-3 align-items-center product-item" id="product-@index">
                                            <div class="col-md-6">
                                                <select name="selectedProducts" class="form-select product-select" onchange="capNhatGia()">
                                                    <option value="">Chọn sản phẩm</option>
                                                    @foreach (var sp in ViewBag.SanPhamList)
                                                    {
                                                        <option value="@sp.MaSanPham" 
                                                                data-price="@sp.Gia"
                                                                data-quantity="@sp.SoLuongTon"
                                                                selected="@(item.MaSanPham == sp.MaSanPham)">
                                                            @sp.TenSanPham - @sp.Gia.ToString("N0")đ 
                                                           
                                                        </option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="number" name="quantities" class="form-control quantity" 
                                                       value="@item.SoLuong" min="1" onchange="capNhatGia()" placeholder="Số lượng">
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeProduct(@index)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        index++;
                                    }
                                }
                            </div>
                            <button type="button" class="btn btn-outline-success btn-sm mt-3" onclick="addProduct()">
                                <i class="fas fa-plus-circle me-1"></i> Thêm sản phẩm
                            </button>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a asp-action="Index" class="text-muted fw-bold small">
                                <i class="fas fa-chevron-left me-1"></i> Quay về
                            </a>
                            <button type="submit" class="btn btn-warning px-5 rounded-pill shadow fw-bold">
                                <i class="fas fa-save me-1"></i> Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let productCount = @(Model.DanhSachChiTietCombo?.Count ?? 0);
        
        function tinhGiaTuDong() {
            let tongGia = 0;
            
            document.querySelectorAll('.product-item').forEach(item => {
                const select = item.querySelector('.product-select');
                const quantityInput = item.querySelector('.quantity');
                
                if (select && select.value && quantityInput) {
                    const price = parseFloat(select.options[select.selectedIndex].dataset.price);
                    const quantity = parseInt(quantityInput.value) || 0;
                    tongGia += price * quantity;
                }
            });
            
            // KHÔNG GIẢM GIÁ - Sử dụng nguyên giá
            const giaCombo = tongGia;
            document.getElementById('giaCombo').value = giaCombo.toFixed(0);
        }
        
        function capNhatGia() {
            const giaInput = document.getElementById('giaCombo');
            // Chỉ cập nhật nếu giá đang là 0 hoặc rỗng
            if (!giaInput.value || giaInput.value == 0) {
                tinhGiaTuDong();
            }
        }
        
        function addProduct() {
            productCount++;
            const container = document.getElementById('product-container');
            const productDiv = document.createElement('div');
            productDiv.className = 'row mb-3 align-items-center product-item';
            productDiv.id = `product-${productCount}`;
            
            productDiv.innerHTML = `
                <div class="col-md-6">
                    <select name="selectedProducts" class="form-select product-select" onchange="capNhatGia()">
                        <option value="">Chọn sản phẩm</option>
                        @foreach (var sp in ViewBag.SanPhamList)
                        {
                            <option value="@sp.MaSanPham" 
                                    data-price="@sp.Gia"
                                    data-quantity="@sp.SoLuongTon">
                                @sp.TenSanPham - @sp.Gia.ToString("N0")đ 
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="number" name="quantities" class="form-control quantity" 
                           value="1" min="1" onchange="capNhatGia()" placeholder="Số lượng">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeProduct(${productCount})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(productDiv);
        }
        
        function removeProduct(id) {
            const element = document.getElementById(`product-${id}`);
            if (element) {
                element.remove();
                capNhatGia();
            }
        }
        
        // Validate form
        document.getElementById('comboForm').addEventListener('submit', function(e) {
            const productItems = document.querySelectorAll('.product-item');
            if (productItems.length === 0) {
                e.preventDefault();
                alert('Vui lòng thêm ít nhất một sản phẩm vào combo!');
                return false;
            }
            
            // Kiểm tra các sản phẩm có được chọn đầy đủ không
            let isValid = true;
            document.querySelectorAll('select[name="selectedProducts"]').forEach(select => {
                if (!select.value) {
                    select.classList.add('is-invalid');
                    isValid = false;
                } else {
                    select.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('Vui lòng chọn sản phẩm cho tất cả các mục!');
                return false;
            }
            
            return true;
        });
    </script>
}